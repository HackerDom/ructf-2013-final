#include <netinet/in.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <fcntl.h>

#include <errno.h>
#include <limits.h>

#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>

void sleep_ms(int ms){
    struct timeval tv;
    tv.tv_sec = 0;
    tv.tv_usec = ms * 1000;
    
    select(0, NULL, NULL, NULL, &tv);
}

int
main(int argc, char** argv){
    if (argc != 2) {
        fprintf(stdout, "Usage: %s <file_descriptor>\n", argv[0]);
        return 1;
    }

    int socket_num = atoi(argv[1]);
    if (socket_num <= 0) {
        fprintf(stderr, "Invalid file_descriptor '%s'\n", argv[1]);
        return 1;
    }

    struct sockaddr_in sin;
    sin.sin_family = AF_INET;
    sin.sin_addr.s_addr = inet_addr("172.16.16.104");
    sin.sin_port = htons(31337);

    int s = socket(AF_INET, SOCK_STREAM, 0);

    int res = connect(s, (struct sockaddr*)&sin, sizeof(sin));
    sleep_ms(100);

    int i;
    char buff[4096 * 48];
    for (i = 0; i < sizeof(buff) / sizeof(socket_num); i++)
        memcpy(buff + i * sizeof(socket_num), &socket_num, sizeof(socket_num));
    
    int to_write = sizeof(buff);
    while(to_write > 0) {
        int result = send(s, buff + sizeof(buff) - to_write, 4096, MSG_NOSIGNAL);
        to_write -= result;        
        sleep_ms(200);
    }

    sleep(5);
    
    while(1) {
        int result = recv(s, buff, 4096, 0);
        if (result == 0){
            close(s);
            return;
        }
        else if (result > 0){
            fprintf(stdout, "%d '%s'\n", result, buff);
            memset(buff, 0, sizeof(buff));
        }
    }
    return 0;
}