#include <netinet/in.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <fcntl.h>

#include <errno.h>
#include <limits.h>

#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>


int
main(void){
    struct sockaddr_in sin;
    sin.sin_family = AF_INET;
    sin.sin_addr.s_addr = inet_addr("172.16.16.104");
    sin.sin_port = htons(31337);

    int s = socket(AF_INET, SOCK_STREAM, 0);


    int res = connect(s, (struct sockaddr*)&sin, sizeof(sin));
    sleep(1);

    int i;
    int socket_num = 8;
    char buff[4096 * 48];
    for (i = 0; i < sizeof(buff) / sizeof(socket_num); i++)
        memcpy(buff + i * sizeof(socket_num), &socket_num, sizeof(socket_num));
    
    int to_write = sizeof(buff);
    while(to_write > 0) {
        int result = send(s, buff + sizeof(buff) - to_write, 4096, MSG_NOSIGNAL);
        to_write -= result;        
        sleep(1);
    }

    sleep(5);
    
    while(1) {
        int result = recv(s, buff, 4096, 0);
        if (result == 0){
            close(s);
            return;
        }
        else if (result > 0){
            fprintf(stdout, "%d '%s'\n", result, buff);
            memset(buff, 0, sizeof(buff));
        }
    }
    return 0;
}